name: Sensor Cost Estimate

on:
  workflow_dispatch:
    inputs:
      start:
        description: 'Start date (YYYY-MM-DD)'
        required: true
        type: string
      end:
        description: 'End date (YYYY-MM-DD)'
        required: true
        type: string
      sources:
        description: 'Comma list of sources (tsi,wu)'
        required: false
        default: 'tsi,wu'
        type: string
      project:
        description: 'GCP Project ID'
        required: false
        default: 'durham-weather-466502'
        type: string
      dataset:
        description: 'BigQuery dataset'
        required: false
        default: 'sensors'
        type: string
      price_per_tb:
        description: 'USD per TB (query)'
        required: false
        default: '6'
        type: string
      storage_price_per_gb_month:
        description: 'USD per GB-month (storage)'
        required: false
        default: '0.02'
        type: string
      storage_days:
        description: 'Days of storage to prorate'
        required: false
        default: '30'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  estimate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-bigquery

      - name: Auth to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_VERIFIER_SA }}
          token_format: access_token

      - name: Run estimator
        run: |
          python scripts/estimate_sensor_costs.py \
            --project "${{ inputs.project }}" \
            --dataset "${{ inputs.dataset }}" \
            --start "${{ inputs.start }}" \
            --end "${{ inputs.end }}" \
            --sources "${{ inputs.sources }}" \
            --price-per-tb "${{ inputs.price_per_tb }}" \
            --storage-price-per-gb-month "${{ inputs.storage_price_per_gb_month }}" \
            --storage-days "${{ inputs.storage_days }}" | tee sensor_cost_estimate.txt

      - name: Upload estimate as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sensor-cost-estimate
          path: sensor_cost_estimate.txt